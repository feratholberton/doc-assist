<main class="layout">
  <section class="card">
    <header class="card__header">
      <h1>Patient Intake</h1>
      <p class="card__subtitle">
        Provide the basic patient details and chief complaint to generate a clinical intake summary.
      </p>
    </header>

    <app-patient-intake-form
      [intakeForm]="intakeForm"
      [genders]="genders()"
      [isSubmitting]="isSubmitting()"
      (submitForm)="submit()"
      (resetForm)="resetForm()"
    />

    @if (submissionResult(); as result) {
      <app-antecedents-section
        [model]="result.model"
        [answer]="result.answer"
        [options]="antecedentOptions()"
        [selected]="selectedAntecedentsList()"
        [customList]="customAntecedentsList()"
        [customText]="customAntecedentText()"
        [isSubmitting]="isSubmitting()"
        [canRequestMore]="canRequestMoreOptions()"
        [isSaving]="isSavingAntecedents()"
        [saveMessage]="antecedentSaveMessage()"
        [saveError]="antecedentSaveError()"
        (requestMore)="requestMoreAntecedents()"
        (toggleOption)="onAntecedentToggle($event.option, $event.checked)"
        (addCustom)="addCustomAntecedent()"
        (customTextChange)="updateCustomAntecedentText($event)"
        (removeCustom)="removeCustomAntecedent($event)"
        (saveConfirmed)="saveConfirmedAntecedents()"
      />
    }

    @if (allergyOptions().length > 0 || antecedentSaveMessage() || antecedentSaveError()) {
      <app-allergies-section
        [options]="allergyOptions()"
        [selected]="selectedAllergiesList()"
        [customList]="customAllergiesList()"
        [customText]="customAllergyText()"
        [canRequestMore]="canRequestMoreAllergies()"
        [isFetching]="isFetchingAllergies()"
        [isSaving]="isSavingAllergies()"
        [saveMessage]="allergySaveMessage()"
        [saveError]="allergySaveError()"
        (toggleOption)="onAllergyToggle($event.option, $event.checked)"
        (requestMore)="requestMoreAllergies()"
        (addCustom)="addCustomAllergy()"
        (customTextChange)="updateCustomAllergyText($event)"
        (removeCustom)="removeCustomAllergy($event)"
        (saveConfirmed)="saveConfirmedAllergies()"
      />
    }

    @if (
      hasSavedAllergies() && (
        drugOptions().length > 0 ||
        customDrugsList().length > 0 ||
        selectedDrugsList().length > 0 ||
        drugSaveMessage() ||
        drugSaveError()
      )
    ) {
      <app-drugs-section
        [options]="drugOptions()"
        [selected]="selectedDrugsList()"
        [customList]="customDrugsList()"
        [customText]="customDrugText()"
        [canRequestMore]="canRequestMoreDrugs()"
        [isFetching]="isFetchingDrugs()"
        [isSaving]="isSavingDrugs()"
        [saveMessage]="drugSaveMessage()"
        [saveError]="drugSaveError()"
        (toggleOption)="onDrugToggle($event.option, $event.checked)"
        (requestMore)="requestMoreDrugs()"
        (addCustom)="addCustomDrug()"
        (customTextChange)="updateCustomDrugText($event)"
        (removeCustom)="removeCustomDrug($event)"
        (saveConfirmed)="saveConfirmedDrugs()"
      />
    }

    @if (submissionError(); as error) {
      <section class="result result--error">
        <h2>Submission Failed</h2>
        <p>{{ error }}</p>
      </section>
    }
  </section>
</main>
