<main class="layout">
  <section class="card">
    <header class="card__header">
      <h1>Patient Intake</h1>
      <p class="card__subtitle">
        Provide the basic patient details and chief complaint to generate a clinical intake summary.
      </p>
    </header>

    <app-patient-intake-form
      [intakeForm]="facade.intakeForm"
      [genders]="facade.genders()"
      [isSubmitting]="facade.isSubmitting()"
      (submitForm)="facade.submit()"
      (resetForm)="facade.resetForm()"
    />

    @if (facade.submissionResult(); as result) {
      <app-antecedents-section
        [model]="result.model"
        [answer]="result.answer"
        [options]="facade.antecedentOptions()"
        [selected]="facade.selectedAntecedentsList()"
        [customList]="facade.customAntecedentsList()"
        [customText]="facade.customAntecedentText()"
        [isSubmitting]="facade.isSubmitting()"
        [canRequestMore]="facade.canRequestMoreOptions()"
        [isSaving]="facade.isSavingAntecedents()"
        [saveMessage]="facade.antecedentSaveMessage()"
        [saveError]="facade.antecedentSaveError()"
        (requestMore)="facade.requestMoreAntecedents()"
        (toggleOption)="facade.onAntecedentToggle($event.option, $event.checked)"
        (addCustom)="facade.addCustomAntecedent()"
        (customTextChange)="facade.updateCustomAntecedentText($event)"
        (removeCustom)="facade.removeCustomAntecedent($event)"
        (saveConfirmed)="facade.saveConfirmedAntecedents()"
      />
    }

    @if (facade.allergyOptions().length > 0 || facade.antecedentSaveMessage() || facade.antecedentSaveError()) {
      <app-allergies-section
        [options]="facade.allergyOptions()"
        [selected]="facade.selectedAllergiesList()"
        [customList]="facade.customAllergiesList()"
        [customText]="facade.customAllergyText()"
        [canRequestMore]="facade.canRequestMoreAllergies()"
        [isFetching]="facade.isFetchingAllergies()"
        [isSaving]="facade.isSavingAllergies()"
        [saveMessage]="facade.allergySaveMessage()"
        [saveError]="facade.allergySaveError()"
        (toggleOption)="facade.onAllergyToggle($event.option, $event.checked)"
        (requestMore)="facade.requestMoreAllergies()"
        (addCustom)="facade.addCustomAllergy()"
        (customTextChange)="facade.updateCustomAllergyText($event)"
        (removeCustom)="facade.removeCustomAllergy($event)"
        (saveConfirmed)="facade.saveConfirmedAllergies()"
      />
    }

    @if (
      facade.hasSavedAllergies() && (
        facade.drugOptions().length > 0 ||
        facade.customDrugsList().length > 0 ||
        facade.selectedDrugsList().length > 0 ||
        facade.drugSaveMessage() ||
        facade.drugSaveError()
      )
    ) {
      <app-drugs-section
        [options]="facade.drugOptions()"
        [selected]="facade.selectedDrugsList()"
        [customList]="facade.customDrugsList()"
        [customText]="facade.customDrugText()"
        [canRequestMore]="facade.canRequestMoreDrugs()"
        [isFetching]="facade.isFetchingDrugs()"
        [isSaving]="facade.isSavingDrugs()"
        [saveMessage]="facade.drugSaveMessage()"
        [saveError]="facade.drugSaveError()"
        (toggleOption)="facade.onDrugToggle($event.option, $event.checked)"
        (requestMore)="facade.requestMoreDrugs()"
        (addCustom)="facade.addCustomDrug()"
        (customTextChange)="facade.updateCustomDrugText($event)"
        (removeCustom)="facade.removeCustomDrug($event)"
        (saveConfirmed)="facade.saveConfirmedDrugs()"
      />
    }

    @if (facade.symptomOnsetQuestions().length > 0) {
      <app-symptom-onset-section
        [questions]="facade.symptomOnsetQuestions()"
        [isSaving]="facade.isSavingSymptomOnset()"
        [saveMessage]="facade.symptomOnsetSaveMessage()"
        [saveError]="facade.symptomOnsetSaveError()"
        (answerChange)="facade.updateSymptomOnsetAnswer($event.id, $event.value)"
        (saveConfirmed)="facade.saveSymptomOnset()"
      />
    }

    @if (facade.evaluationQuestions().length > 0) {
      <app-evaluation-section
        [questions]="facade.evaluationQuestions()"
        [isSaving]="facade.isSavingEvaluation()"
        [saveMessage]="facade.evaluationSaveMessage()"
        [saveError]="facade.evaluationSaveError()"
        (answerChange)="facade.updateEvaluationAnswer($event.id, $event.value)"
        (saveConfirmed)="facade.saveEvaluation()"
      />
    }

    @if (facade.locationQuestions().length > 0) {
      <app-location-section
        [questions]="facade.locationQuestions()"
        [isSaving]="facade.isSavingLocation()"
        [saveMessage]="facade.locationSaveMessage()"
        [saveError]="facade.locationSaveError()"
        (answerChange)="facade.updateLocationAnswer($event.id, $event.value)"
        (saveConfirmed)="facade.saveLocation()"
      />
    }

    @if (facade.characteristicsQuestions().length > 0) {
      <app-characteristics-section
        [questions]="facade.characteristicsQuestions()"
        [isSaving]="facade.isSavingCharacteristics()"
        [saveMessage]="facade.characteristicsSaveMessage()"
        [saveError]="facade.characteristicsSaveError()"
        (answerChange)="facade.updateCharacteristicsAnswer($event.id, $event.value)"
        (saveConfirmed)="facade.saveCharacteristics()"
      />
    }

    @if (facade.associatedSymptomsQuestions().length > 0) {
      <app-associated-symptoms-section
        [questions]="facade.associatedSymptomsQuestions()"
        [isSaving]="facade.isSavingAssociated()"
        [saveMessage]="facade.associatedSaveMessage()"
        [saveError]="facade.associatedSaveError()"
        (answerChange)="facade.updateAssociatedAnswer($event.id, $event.value)"
        (saveConfirmed)="facade.saveAssociated()"
      />
    }

    @if (facade.precipitatingFactorsQuestions().length > 0) {
      <app-precipitating-factors-section
        [questions]="facade.precipitatingFactorsQuestions()"
        [isSaving]="facade.isSavingPrecipitating()"
        [saveMessage]="facade.precipitatingSaveMessage()"
        [saveError]="facade.precipitatingSaveError()"
        (answerChange)="facade.updatePrecipitatingAnswer($event.id, $event.value)"
        (saveConfirmed)="facade.savePrecipitating()"
      />
    }

    @if (facade.recentExposuresQuestions().length > 0) {
      <app-recent-exposures-section
        [questions]="facade.recentExposuresQuestions()"
        [isSaving]="facade.isSavingRecentExposures()"
        [saveMessage]="facade.recentExposuresSaveMessage()"
        [saveError]="facade.recentExposuresSaveError()"
        (answerChange)="facade.updateRecentExposuresAnswer($event.id, $event.value)"
        (saveConfirmed)="facade.saveRecentExposures()"
      />
    }

    @if (facade.functionalImpactQuestions().length > 0) {
      <app-functional-impact-section
        [questions]="facade.functionalImpactQuestions()"
        [isSaving]="facade.isSavingFunctionalImpact()"
        [saveMessage]="facade.functionalImpactSaveMessage()"
        [saveError]="facade.functionalImpactSaveError()"
        (answerChange)="facade.updateFunctionalImpactAnswer($event.id, $event.value)"
        (saveConfirmed)="facade.saveFunctionalImpact()"
      />
    }

    @if (facade.priorTherapiesQuestions().length > 0) {
      <app-prior-therapies-section
        [questions]="facade.priorTherapiesQuestions()"
        [isSaving]="facade.isSavingPriorTherapies()"
        [saveMessage]="facade.priorTherapiesSaveMessage()"
        [saveError]="facade.priorTherapiesSaveError()"
        (answerChange)="facade.updatePriorTherapiesAnswer($event.id, $event.value)"
        (saveConfirmed)="facade.savePriorTherapies()"
      />
    }

    @if (facade.redFlagsQuestions().length > 0) {
      <app-red-flags-section
        [questions]="facade.redFlagsQuestions()"
        [isSaving]="facade.isSavingRedFlags()"
        [saveMessage]="facade.redFlagsSaveMessage()"
        [saveError]="facade.redFlagsSaveError()"
        (answerChange)="facade.updateRedFlagsAnswer($event.id, $event.value)"
        (saveConfirmed)="facade.saveRedFlags()"
      />
    }

    @if (facade.reviewSummary(); as summary) {
      <app-review-panel
        [content]="summary"
        [isCopying]="facade.isCopyingReview()"
        [copyMessage]="facade.copyMessage()"
        [copyError]="facade.copyError()"
        (copyRequested)="facade.copyReviewToClipboard()"
      />
    }

    @if (facade.submissionError(); as error) {
      <section class="result result--error">
        <h2>Submission Failed</h2>
        <p>{{ error }}</p>
      </section>
    }
  </section>
</main>
