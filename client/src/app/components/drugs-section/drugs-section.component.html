<section class="drugs" aria-labelledby="drugs-heading">
  <header class="drugs__header">
    <h2 id="drugs-heading">Medicamentos sugeridos</h2>
    <p class="drugs__description">
      Selecciona los medicamentos potenciales a considerar para este caso clínico.
    </p>
  </header>

  @if (options().length > 0) {
    <fieldset class="drugs__fieldset">
      <legend class="drugs__legend">Selecciona los medicamentos relevantes</legend>
      <div class="drugs__grid">
        @for (option of options(); track option) {
          <label class="drugs__option">
            <input
              #optionInput
              type="checkbox"
              [checked]="isSelected(option)"
              (change)="onCheckboxChange(option, optionInput.checked)"
            />
            <span class="drugs__label">{{ option }}</span>
          </label>
        }
      </div>
    </fieldset>
  } @else {
    <p class="drugs__empty">Todavía no hay medicamentos sugeridos para este caso.</p>
  }

  <div class="drugs__actions">
    <button
      type="button"
      class="drugs__actions-button"
      (click)="onRequestMore()"
      [disabled]="isFetching() || !canRequestMore()"
    >
      {{ isFetching() ? 'Solicitando nuevos medicamentos…' : 'Necesito otros medicamentos' }}
    </button>
  </div>

  <div class="drugs__custom">
    <label class="drugs__custom-label" for="customDrug">Agregar medicamento personalizado</label>
    <div class="drugs__custom-controls">
      <input
        id="customDrug"
        type="text"
        class="drugs__custom-input"
        #customDrugInput
        [value]="customText()"
        (input)="onCustomTextInput(customDrugInput.value)"
        [disabled]="isFetching() || isSaving()"
        placeholder="Ej.: Amoxicilina"
      />
      <button
        type="button"
        class="drugs__custom-add"
        (click)="onAddCustom()"
        [disabled]="isFetching() || isSaving() || customText().trim().length === 0"
      >
        Añadir
      </button>
    </div>

    @if (customList().length > 0) {
      <ul class="drugs__custom-list">
        @for (custom of customList(); track custom) {
          <li class="drugs__custom-item">
            <span>{{ custom }}</span>
            <button
              type="button"
              class="drugs__custom-remove"
              (click)="onRemoveCustom(custom)"
              [disabled]="isFetching() || isSaving()"
            >
              Quitar
            </button>
          </li>
        }
      </ul>
    }
  </div>

  @if (selected().length > 0) {
    <div class="drugs__selection">
      <span class="drugs__selection-label">Medicamentos seleccionados:</span>
      <ul class="drugs__selection-list">
        @for (item of selected(); track item) {
          <li>{{ item }}</li>
        }
      </ul>
    </div>
  }

  <div class="drugs__save">
    <button
      type="button"
      class="drugs__save-button"
      (click)="onSaveConfirmed()"
      [disabled]="isSaving() || selected().length === 0"
    >
      {{ isSaving() ? 'Guardando medicamentos…' : 'Guardar medicamentos confirmados' }}
    </button>

    @if (saveMessage()) {
      <p class="drugs__save-message drugs__save-message--success">{{ saveMessage() }}</p>
    }

    @if (saveError()) {
      <p class="drugs__save-message drugs__save-message--error">{{ saveError() }}</p>
    }
  </div>
</section>
