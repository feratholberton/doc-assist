<section class="allergies" aria-labelledby="allergies-heading">
  <header class="allergies__header">
    <h2 id="allergies-heading">Alergias sugeridas</h2>
    <p class="allergies__description">
      Selecciona las alergias farmacológicas o ambientales que deban investigarse en este paciente.
    </p>
  </header>

  @if (options().length > 0) {
    <fieldset class="allergies__fieldset">
      <legend class="allergies__legend">Selecciona las alergias relevantes</legend>
      <div class="allergies__grid">
        @for (option of options(); track option) {
          <label class="allergies__option">
            <input
              #optionInput
              type="checkbox"
              [checked]="isSelected(option)"
              (change)="onCheckboxChange(option, optionInput.checked)"
            />
            <span class="allergies__label">{{ option }}</span>
          </label>
        }
      </div>
    </fieldset>
  } @else {
    <p class="allergies__empty">Todavía no hay alergias sugeridas para este caso.</p>
  }

  <div class="allergies__actions">
    <button
      type="button"
      class="allergies__actions-button"
      (click)="onRequestMore()"
      [disabled]="isFetching() || !canRequestMore()"
    >
      {{ isFetching() ? 'Solicitando nuevas alergias…' : 'Necesito otras alergias' }}
    </button>
  </div>

  <div class="allergies__custom">
    <label class="allergies__custom-label" for="customAllergy">Agregar alergia personalizada</label>
    <div class="allergies__custom-controls">
      <input
        id="customAllergy"
        type="text"
        class="allergies__custom-input"
        #customAllergyInput
        [value]="customText()"
        (input)="onCustomTextInput(customAllergyInput.value)"
        [disabled]="isFetching() || isSaving()"
        placeholder="Ej.: Penicilina"
      />
      <button
        type="button"
        class="allergies__custom-add"
        (click)="onAddCustom()"
        [disabled]="isFetching() || isSaving() || customText().trim().length === 0"
      >
        Añadir
      </button>
    </div>

    @if (customList().length > 0) {
      <ul class="allergies__custom-list">
        @for (custom of customList(); track custom) {
          <li class="allergies__custom-item">
            <span>{{ custom }}</span>
            <button
              type="button"
              class="allergies__custom-remove"
              (click)="onRemoveCustom(custom)"
              [disabled]="isFetching() || isSaving()"
            >
              Quitar
            </button>
          </li>
        }
      </ul>
    }
  </div>

  @if (selected().length > 0) {
    <div class="allergies__selection">
      <span class="allergies__selection-label">Alergias seleccionadas:</span>
      <ul class="allergies__selection-list">
        @for (item of selected(); track item) {
          <li>{{ item }}</li>
        }
      </ul>
    </div>
  }

  <div class="allergies__save">
    <button
      type="button"
      class="allergies__save-button"
      (click)="onSaveConfirmed()"
      [disabled]="isSaving() || selected().length === 0"
    >
      {{ isSaving() ? 'Guardando alergias…' : 'Guardar alergias confirmadas' }}
    </button>

    @if (saveMessage()) {
      <p class="allergies__save-message allergies__save-message--success">{{ saveMessage() }}</p>
    }

    @if (saveError()) {
      <p class="allergies__save-message allergies__save-message--error">{{ saveError() }}</p>
    }
  </div>
</section>
